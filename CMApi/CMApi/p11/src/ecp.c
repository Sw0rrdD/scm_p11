/*******************************************************************************
版权声明: Copyright(C) Westone Co., Ltd. 2017-2018. All rights reserved.
文件名称: ecp.c
文件描述: ecp算法相关
创 建 者: 陈位仅
创建时间: 2017年3月30日
修改历史:
1. 2017年3月30日	陈位仅		创建文件 
*******************************************************************************/

#include "ecp.h"
#include "bn.h"

EC mEC_SM2;
static unsigned char SM2_SystemParameter[]={
		0x00, 0x00, 0x00, 0x01, 0x72, 0x35, 0x09, 0x75,
		0xff, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,//p
		0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03,
		0xff, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x72, 0x03, 0xdf, 0x6b, 0x21, 0xc6, 0x05, 0x2b, 0x53, 0xbb, 0xf4, 0x09, 0x39, 0xd5, 0x41, 0x23,//n
		0x1e, 0xb5, 0xe4, 0x12, 0xa2, 0x2b, 0x3d, 0x3b, 0x62, 0x0f, 0xc8, 0x4c, 0x3a, 0xff, 0xe0, 0xd4, 0x34, 0x64, 0x50, 0x4a, 0xde, 0x6f, 0xa2, 0xfa, 0x90, 0x11, 0x92, 0xaf, 0x7c, 0x11, 0x4f, 0x20,
		0xff, 0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc,
		0x91, 0x16, 0x7a, 0x5e, 0xe1, 0xc1, 0x3b, 0x05, 0xd6, 0xa1, 0xed, 0x99, 0xac, 0x24, 0xc3, 0xc3, 0x3e, 0x79, 0x81, 0xed, 0xdc, 0xa6, 0xc0, 0x50, 0x61, 0x32, 0x89, 0x90, 0xf4, 0x18, 0x02, 0x9e,
		0x63, 0xcd, 0x65, 0xd4, 0x81, 0xd7, 0x35, 0xbd, 0x8d, 0x4c, 0xfb, 0x06, 0x6e, 0x2a, 0x48, 0xf8, 0xc1, 0xf5, 0xe5, 0x78, 0x8d, 0x32, 0x95, 0xfa, 0xc1, 0x35, 0x4e, 0x59, 0x3c, 0x2d, 0x0d, 0xdd,
		0xc9, 0xe6, 0x50, 0x40, 0x56, 0x8b, 0x4c, 0x56, 0x68, 0x00, 0xf6, 0x96, 0x51, 0x9b, 0x4c, 0x35, 0x2b, 0xf7, 0x13, 0x0e, 0x91, 0x54, 0xd3, 0x77, 0x7b, 0x9f, 0x56, 0x1a, 0x8a, 0x91, 0x4b, 0x50,
		0x63, 0x56, 0xcf, 0x46, 0x8c, 0x16, 0x67, 0x47, 0x1f, 0xff, 0x9e, 0x3d, 0x40, 0x56, 0x2e, 0x5f, 0x78, 0x1a, 0x12, 0xf6, 0xe2, 0x11, 0xce, 0x1e, 0x30, 0x70, 0x6e, 0x00, 0x6d, 0x98, 0xa3, 0x31,
		0x5c, 0x01, 0xaf, 0x69, 0xa3, 0x03, 0xef, 0x24, 0xfa, 0x0b, 0xd6, 0xc0, 0x07, 0xf7, 0xce, 0xb5, 0x38, 0x25, 0xd8, 0x0c, 0x66, 0xf7, 0x5b, 0x0d, 0x96, 0xc4, 0xe4, 0xf3, 0x89, 0x75, 0x18, 0xd9,
		0x6f, 0x35, 0x08, 0x80, 0x16, 0x8c, 0xcb, 0x86, 0x51, 0x93, 0x62, 0xc6, 0x95, 0x37, 0x34, 0x21, 0x8b, 0xfe, 0x4a, 0x53, 0x24, 0x8d, 0xce, 0xae, 0xdd, 0x75, 0xcf, 0x9e, 0x6b, 0xfc, 0xbc, 0x92,
		0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,//a
		0x28, 0xE9, 0xFA, 0x9E, 0x9D, 0x9F, 0x5E, 0x34, 0x4D, 0x5A, 0x9E, 0x4B, 0xCF, 0x65, 0x09, 0xA7, 0xF3, 0x97, 0x89, 0xF5, 0x15, 0xAB, 0x8F, 0x92, 0xDD, 0xBC, 0xBD, 0x41, 0x4D, 0x94, 0x0E, 0x93,//b
		0x32, 0xC4, 0xAE, 0x2C, 0x1F, 0x19, 0x81, 0x19, 0x5F, 0x99, 0x04, 0x46, 0x6A, 0x39, 0xC9, 0x94, 0x8F, 0xE3, 0x0B, 0xBF, 0xF2, 0x66, 0x0B, 0xE1, 0x71, 0x5A, 0x45, 0x89, 0x33, 0x4C, 0x74, 0xC7,//GX
		0xBC, 0x37, 0x36, 0xA2, 0xF4, 0xF6, 0x77, 0x9C, 0x59, 0xBD, 0xCE, 0xE3, 0x6B, 0x69, 0x21, 0x53, 0xD0, 0xA9, 0x87, 0x7C, 0xC6, 0x2A, 0x47, 0x40, 0x02, 0xDF, 0x32, 0xE5, 0x21, 0x39, 0xF0, 0xA0,//GY

};

void ECPDoubleJ(pJ_Point pjJp)
{
	Word bn1[MAXBNWordLen]; 
	Word bn2[MAXBNWordLen];
	Word bn3[MAXBNWordLen];
	Word bn4[MAXBNWordLen];
	Word bn5[MAXBNWordLen];
    Word *bnX,*bnY,*bnZ,*bnP,*bnMona;
	Word MC;
		
	MC=mEC_SM2.EC_P_MC;
	bnP=mEC_SM2.EC_P;
	bnMona=mEC_SM2.EC_mona;
	bnX=pjJp->X;
    bnY=pjJp->Y;
    bnZ=pjJp->Z;

	BNMonMul(bn4,bnY,bnY,bnP,MC);
    BNMonMul(bn1,bn4,bnX,bnP,MC);
    BNModAdd(bn1,bn1,bn1,bnP);
    BNModAdd(bn1,bn1,bn1,bnP);
    BNMonMul(bn2,bn4,bn4,bnP,MC);
    BNModAdd(bn2,bn2,bn2,bnP);
    BNModAdd(bn2,bn2,bn2,bnP);
    BNModAdd(bn2,bn2,bn2,bnP);
    BNMonMul(bn4,bnZ,bnZ,bnP,MC);
    BNMonMul(bn4,bn4,bn4,bnP,MC);
    BNMonMul(bn4,bn4,bnMona,bnP,MC);
    BNMonMul(bn3,bnX,bnX,bnP,MC);
    BNModAdd(bn5,bn3,bn3,bnP);
    BNModAdd(bn3,bn5,bn3,bnP);
    BNModAdd(bn3,bn3,bn4,bnP);
    BNMonMul(bnX,bn3,bn3,bnP,MC);
    BNModSub(bnX,bnX,bn1,bnP);
    BNModSub(bnX,bnX,bn1,bnP);
    BNModSub(bn1,bn1,bnX,bnP);
    BNMonMul(bn1,bn1,bn3,bnP,MC);
    BNMonMul(bnZ,bnY,bnZ,bnP,MC);
    BNModAdd(bnZ,bnZ,bnZ,bnP);
    BNModSub(bnY,bn1,bn2,bnP);
}

void ECPJAddA(pJ_Point pjJp, pA_Point paAp)
{
	Word bn1[MAXBNWordLen]; 
	Word bn2[MAXBNWordLen];
	Word bn3[MAXBNWordLen];
    Word *bnX1,*bnY1,*bnZ1,*bnP;
	int i;
	Word MC;
	MC=mEC_SM2.EC_P_MC;
	bnX1=pjJp->X;
    bnY1=pjJp->Y;
    bnZ1=pjJp->Z;
	bnP=mEC_SM2.EC_P;

	for (i = 0; i < BNWORDLEN; i++)
			bn1[i] = 0;
	
	if(BNCompare(bnZ1,bnP)==0||BNCompare(bnZ1,bn1)==0)
	{
		BNAssign(bnX1,paAp->X);
		BNAssign(bnY1,paAp->Y);
		bn1[0] = 1;
		BNMonMul(bnZ1, bn1, mEC_SM2.EC_RR, bnP, MC);
		return ;
	}

    BNMonMul(bn3,bnZ1,bnZ1,bnP,MC);
    BNMonMul(bn2,bnZ1,bn3,bnP,MC);
    BNMonMul(bn3,bn3,paAp->X,bnP,MC);
    BNModSub(bn3,bn3,bnX1,bnP);
    BNMonMul(bnZ1,bnZ1,bn3,bnP,MC);
    BNMonMul(bn2,bn2,paAp->Y,bnP,MC);
    BNModSub(bn2,bn2,bnY1,bnP);
    BNMonMul(bn1,bn3,bn3,bnP,MC);
    BNMonMul(bn3,bn3,bn1,bnP,MC);
    BNMonMul(bn1,bn1,bnX1,bnP,MC);
    BNModAdd(bnX1,bn1,bn1,bnP);
    BNModAdd(bnX1,bnX1,bn3,bnP);
    BNMonMul(bnY1,bnY1,bn3,bnP,MC);
    BNMonMul(bn3,bn2,bn2,bnP,MC);
    BNModSub(bnX1,bn3,bnX1,bnP);
    BNModSub(bn1,bn1,bnX1,bnP);
    BNMonMul(bn1,bn1,bn2,bnP,MC);
    BNModSub(bnY1,bn1,bnY1,bnP);
}

void ECPJToA(pJ_Point pjJp, pA_Point paAp)
{

	Word bn1[MAXBNWordLen]; 
	Word bn2[MAXBNWordLen];
	Word *bnP,*EC_RR;
	Word MC;
	int i;
	
	bnP=mEC_SM2.EC_P;
    MC=mEC_SM2.EC_P_MC;
	EC_RR=mEC_SM2.EC_RR;


    for (i = 0; i < BNWORDLEN; i++)
        bn2[i] = 0;
    bn2[0] = 1;

    BNMonMul(bn1, pjJp->Z, pjJp->Z, bnP, MC);
    BNMonMul(bn1, bn1, pjJp->Z, bnP, MC);
   	BNMonMul(bn1, bn1, bn2,bnP,MC);
	BNMonInv(bn1, bn1, bnP,MC,EC_RR);
   	BNMonMul(paAp->Y,pjJp->Y,bn1,bnP,MC);
    BNMonMul(paAp->Y,paAp->Y,bn2,bnP,MC);
    BNMonMul(bn1, bn1, pjJp->Z, bnP,MC);
    BNMonMul(paAp->X, pjJp->X, bn1, bnP,MC);
    BNMonMul(paAp->X, paAp->X, bn2, bnP,MC);
    BNModSub(paAp->X,paAp->X,bnP,bnP);
    BNModSub(paAp->Y,paAp->Y,bnP,bnP);

}

/*******************************************************************************
函 数 名:   InitByParameter
功能描述:   初始化点乘运算所需参数
说    明:   无
注    意:   无
参数说明:   
	pbSystemParameter	(in)	乘运算参数
返 回 值:   无
修改历史: 
    1. 2017年3月30日	陈位仅		函数改造
*******************************************************************************/
int InitByParameter(char *pbSystemParameter)
{
	int iBNByteLen;
	
	Byte2Word(pbSystemParameter,0, &(mEC_SM2.EC_P_MC));
	Byte2Word(pbSystemParameter,4, &(mEC_SM2.EC_N_MC));
	
	iBNByteLen=4*BNWORDLEN;
	
	Byte2BN(pbSystemParameter,8,               iBNByteLen,mEC_SM2.EC_P       );
	Byte2BN(pbSystemParameter,8+  iBNByteLen,  iBNByteLen,mEC_SM2.EC_RR      );
	Byte2BN(pbSystemParameter,8+2*iBNByteLen,  iBNByteLen,mEC_SM2.EC_N       );
	Byte2BN(pbSystemParameter,8+3*iBNByteLen,  iBNByteLen,mEC_SM2.EC_NRR     );
	Byte2BN(pbSystemParameter,8+4*iBNByteLen,  iBNByteLen,mEC_SM2.EC_mona    );
	Byte2BN(pbSystemParameter,8+5*iBNByteLen,  iBNByteLen,mEC_SM2.TableG[0].X);
	Byte2BN(pbSystemParameter,8+6*iBNByteLen,  iBNByteLen,mEC_SM2.TableG[0].Y);
	Byte2BN(pbSystemParameter,8+7*iBNByteLen,  iBNByteLen,mEC_SM2.TableG[1].X);
	Byte2BN(pbSystemParameter,8+8*iBNByteLen,  iBNByteLen,mEC_SM2.TableG[1].Y);
	Byte2BN(pbSystemParameter,8+9*iBNByteLen,  iBNByteLen,mEC_SM2.TableG[2].X);
	Byte2BN(pbSystemParameter,8+10*iBNByteLen, iBNByteLen,mEC_SM2.TableG[2].Y);

	return 1;
}


/*******************************************************************************
函 数 名:   PorintMul
功能描述:   点乘运算
说    明:   无
注    意:   无
参数说明:   
	K	(in)	点乘运算参数
	P	(in)	点乘运算参数
	KP	(out)	点乘运算结果输出
返 回 值:   无
修改历史: 
    1. 2017年3月30日	陈位仅		函数改造
*******************************************************************************/
void  PorintMul(Word *K, pA_Point P,pA_Point KP)
{
    J_Point jp;
    A_Point ap;
    Word *EC_P,*EC_RR;
	Word MC;
	Byte BitBuf[MAXBNBitLen];	
    int i,BitLen;

	InitByParameter(SM2_SystemParameter);
	
	EC_P=mEC_SM2.EC_P;
	MC=mEC_SM2.EC_P_MC;
	EC_RR=mEC_SM2.EC_RR;

	
    BNMonMul(ap.X, P->X, EC_RR, EC_P, MC);
    BNMonMul(ap.Y, P->Y, EC_RR, EC_P, MC);
    BNAssign(jp.X,ap.X);
    BNAssign(jp.Y,ap.Y);

    for (i = 0; i < BNWORDLEN; i++)
        jp.Z[i] = 0;
    jp.Z[0] = 1;

    BNMonMul(jp.Z, jp.Z, EC_RR, EC_P,MC);
    
    BitLen = BN2Bit(K, BitBuf);

    if(BitLen<2)
        return;
	
    for(i=BitLen-2;i>=0;i--)
    {
        ECPDoubleJ(&jp);
        if(BitBuf[i]==1)
	        ECPJAddA(&jp,&ap);
    }
    ECPJToA(&jp,KP);
}

